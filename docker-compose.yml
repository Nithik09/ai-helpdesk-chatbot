services:
	postgres:
		image: postgres:16
		container_name: helpdesk_postgres
		environment:
			POSTGRES_DB: helpdesk
			POSTGRES_USER: helpdesk
			POSTGRES_PASSWORD: helpdesk
		ports:
			- "5432:5432"
		volumes:
			- pg_data:/var/lib/postgresql/data

	qdrant:
		image: qdrant/qdrant:v1.9.4
		container_name: helpdesk_qdrant
		ports:
			- "6333:6333"
		volumes:
			- qdrant_data:/qdrant/storage

	n8n:
		image: n8nio/n8n:1.62.3
		container_name: helpdesk_n8n
		ports:
			- "5678:5678"
		environment:
			- N8N_HOST=n8n
			- N8N_PORT=5678
			- N8N_PROTOCOL=http
			- WEBHOOK_URL=http://n8n:5678/
			- N8N_EDITOR_BASE_URL=http://localhost:5678/
			- N8N_BASIC_AUTH_ACTIVE=true
			- N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
			- N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
			- N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
			- N8N_DIAGNOSTICS_ENABLED=false
			- N8N_PERSONALIZATION_ENABLED=false
		volumes:
			- n8n_data:/home/node/.n8n
			- ./scripts/sample_docs:/data/docs:ro
		depends_on:
			- postgres
			- qdrant

	backend:
		build:
			context: ./backend
			dockerfile: Dockerfile
		container_name: helpdesk_backend
		environment:
			- DATABASE_URL=postgresql+psycopg2://helpdesk:helpdesk@postgres:5432/helpdesk
			- N8N_CHAT_WEBHOOK_URL=http://n8n:5678/webhook/helpdesk-chat
			- N8N_CREATE_TICKET_WEBHOOK_URL=http://n8n:5678/webhook/create-ticket
			- N8N_TICKET_STATUS_WEBHOOK_URL=http://n8n:5678/webhook/ticket-status
			- EMBEDDING_MODEL=all-MiniLM-L6-v2
			- CORS_ORIGINS=http://localhost:5173
			- DEMO_SEED=true
		ports:
			- "8000:8000"
		depends_on:
			- postgres
			- qdrant
			- n8n

	frontend:
		build:
			context: ./frontend
			dockerfile: Dockerfile
		container_name: helpdesk_frontend
		environment:
			- VITE_API_URL=http://localhost:8000
		ports:
			- "5173:5173"
		depends_on:
			- backend

volumes:
	pg_data:
	qdrant_data:
	n8n_data:
